---
###
# this file is run for a specific server and creates the needed monitor files for it.
# {{ working_dir }} is set when this file is included and goes to the ansible root directory + includes the servers host name for the folder
# any monitor file commands must be also set in the nrpe.conf file if you are adding any

# makes a folder in /etc/nagios or where ever the nagios working path is set to using the servers hostname
# loops through all the servers in the group nagios and creates the folders for the host files there. 
- name: create folder for host
  file: path="{{ working_dir }}/" state=directory
  delegate_to: "{{ item }}"
  with_items: groups.nagios

# adds templates to the host file directory created above and uses template files from roles/nagios/files/ which are configured to grab server information
- name: setup general monitor files
  template: src=roles/nagios/files/{{ item[0] }} dest="{{ working_dir }}/{{ item[0] }}.cfg"
  delegate_to: "{{ item[1] }}"
  with_nested:
    - [ 'host', 'ping', 'load', 'swap', 'ssh', 'diskusage', 'dns' ]
    - groups.nagios

# Checks to see if mysql is installed on the server. if it is then a monitor file is created for it and a nrpe mysql user is created
- name: check for mysql
  command: rpm -q mysql-server
  register: mysqlCheck

- name: create mysql montior
  template: src=roles/nagios/files/mysql dest="{{ working_dir }}/mysql.cfg"
  delegate_to: "{{ item }}"
  with_items: groups.nagios
  when: mysqlCheck.rc == 0

- name: double check required python module
  yum: name=MySQL-python state=latest

- name: create nrpe mysql user
  mysql_user: name=nrpe host={{ item }} password=lzEneD9FdPVxw6tk6a
  with_items:
    - "{{ ansible_hostname }}"
    - 127.0.0.1
    - ::1
    - localhost
  when: mysqlCheck.rc == 0

# Checks to see if the server is listening on the mail port 25 and if so sets up a monitor to check the mail server
- name: check for mail server
  command: netstat -lnp | grep ':25'
  register: mailCheck

- name: setup mail server monitor files
  template: src=roles/nagios/files/{{ item[0] }} dest="{{ working_dir }}/{{ item[0] }}.cfg"
  delegate_to: "{{ item[1] }}"
  with_nested:
    - [ 'mailq', 'smtp', 'imap', 'pop']
    - groups.nagios
  when: mailCheck.stdout.find(':25') != -1

#check for ftp server
- name: check for ftp server
  command: netstat -lnp | grep ':21'
  register: ftpCheck

- name: create ftp montior
  template: src=roles/nagios/files/ftp dest="{{ working_dir }}/ftp.cfg"
  delegate_to: "{{ item }}"
  with_items: groups.nagios
  when: ftpCheck.stdout.find(':21') != -1

#check http
- name: check for http
  command: netstat -lnp | grep ':80'
  register: httpCheck

- name: create http montior
  template: src=roles/nagios/files/http dest="{{ working_dir }}/http.cfg"
  delegate_to: "{{ item }}"
  with_items: groups.nagios
  when: httpCheck.stdout.find(':80') != -1


# restarts all the nagios servers so changes are applied
- name: restart nagios
  service: name=nagios state=restarted
  delegate_to: "{{ item }}"
  with_items: groups.nagios
